name: 'On pull request'

on:
  workflow_call:
    inputs:
      require-manual-tests:
        required: false
        type: boolean
        default: true
        description: |
          Requires a team member of author to assign a 'tested' label to a PR, 
          confirming that the manual tests were performed and passed.

jobs:
  manual-test:
    name: "Enforce manual tests"
    if: inputs.require-manual-tests && contains(fromJSON('["labeled", "unlabeled", "opened"]'), github.event.action)
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: "Manual tests reminder"
        if: github.event.action == 'opened'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} -R $GITHUB_REPOSITORY \
          -b '### Manual Tests
          :information_source: Remember to ask team members to perform manual tests and to assign `tested` label after testing.'
          
          echo "::error title=Waiting for manual tests to be performed.::Waiting for manual tests to be performed. Please add 'tested' label after testing."
          exit 1
      - name: "Fail if tested label is not assigned"
        if: contains(github.event.pull_request.labels.*.name, 'tested') != true
        run: |
          gh pr comment ${{ github.event.pull_request.number }} -R $GITHUB_REPOSITORY \
          --edit-last \
          -b '### Manual Tests
          :information_source: Remember to ask team members to perform manual tests and to assign `tested` label after testing.'
          
          echo "::error title=Waiting for manual tests to be performed.::Waiting for manual tests to be performed. Please add 'tested' label after testing."
          exit 1

      - name: "Set author_manual_test value"
        if: |
          github.event.action == 'labeled' 
           && github.event.label.name == 'tested'
           && github.event.pull_request.user.login == github.event.sender.login
        run: |
          echo "author_manual_test=true" >> $GITHUB_ENV

      - name: "Comment if author assigned label tested"
        if: env.author_manual_test
        run: |
          gh pr comment ${{ github.event.pull_request.number }} -R $GITHUB_REPOSITORY \
          --edit-last \
          -b '### Manual Tests
          :red_circle: Manual testing should not be performed by author.
          Ask other team member to perform a manual tests and to assign `tested` label after testing.'

      - name: "Remove tested label if author assigned it"
        if: env.author_manual_test
        run: |
          gh pr edit ${{ github.event.pull_request.number }} -R $GITHUB_REPOSITORY \
          --remove-label tested

      - name: "Fail if author assigned label tested"
        if: env.author_manual_test
        run: |
          echo "::error title=Author manual tests.::Manual tests should be performed by someone other than the PR author."
          exit 1

      - name: "Add comment that tests were preformed"
        if: github.event.action == 'labeled' && github.event.label.name == 'tested'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} -R $GITHUB_REPOSITORY \
          --edit-last \
          -b '### Manual Tests

          :green_heart: Manual testing by @${{ github.event.pull_request.user.login }} resulted in success.'
